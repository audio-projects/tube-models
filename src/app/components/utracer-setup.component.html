<div class="modal-backdrop" (click)="!isReading && close()"></div>
<div class="modal d-block">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-gear-fill me-2"></i>uTracer Setup
        </h5>
        <button type="button" class="btn-close" (click)="close()" [disabled]="isReading" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="utracer-version" class="form-label">uTracer Version</label>
          <select 
            id="utracer-version" 
            class="form-select" 
            [(ngModel)]="uTracerVersion" 
            (change)="onVersionChange()"
            [disabled]="isReading">
            <option value="3">uTracer 3 (300V)</option>
            <option value="3+">uTracer 3+ (400V)</option>
          </select>
          <div class="form-text">Select your uTracer hardware version - selecting incorrect version could damage your uTracer</div>
        </div>

        <h6 class="mt-4 mb-3">Calibration</h6>

        <div class="mb-3">
          <label for="plate-voltage-gain" class="form-label">Plate Voltage Gain: {{plateVoltageGain.toFixed(3)}}</label>
          <input 
            type="range" 
            class="form-range" 
            id="plate-voltage-gain"
            min="0.9" 
            max="1.1" 
            step="0.001"
            [(ngModel)]="plateVoltageGain" 
            (input)="onPlateVoltageGainChange()"
            [disabled]="isReading">
        </div>

        <div class="mb-3">
          <label for="screen-voltage-gain" class="form-label">Screen Voltage Gain: {{screenVoltageGain.toFixed(3)}}</label>
          <input 
            type="range" 
            class="form-range" 
            id="screen-voltage-gain"
            min="0.9" 
            max="1.1" 
            step="0.001"
            [(ngModel)]="screenVoltageGain" 
            (input)="onScreenVoltageGainChange()"
            [disabled]="isReading">
        </div>

        <div class="mb-3">
          <label for="plate-current-gain" class="form-label">Plate Current Gain: {{plateCurrentGain.toFixed(3)}}</label>
          <input 
            type="range" 
            class="form-range" 
            id="plate-current-gain"
            min="0.9" 
            max="1.1" 
            step="0.001"
            [(ngModel)]="plateCurrentGain" 
            (input)="onPlateCurrentGainChange()"
            [disabled]="isReading">
        </div>

        <div class="mb-3">
          <label for="screen-current-gain" class="form-label">Screen Current Gain: {{screenCurrentGain.toFixed(3)}}</label>
          <input 
            type="range" 
            class="form-range" 
            id="screen-current-gain"
            min="0.9" 
            max="1.1" 
            step="0.001"
            [(ngModel)]="screenCurrentGain" 
            (input)="onScreenCurrentGainChange()"
            [disabled]="isReading">
        </div>

        <div class="mb-3">
          <label for="power-supply-voltage" class="form-label">Power Supply Voltage Factor: {{powerSupplyVoltageFactor.toFixed(3)}}</label>
          <input 
            type="range" 
            class="form-range" 
            id="power-supply-voltage-factor"
            min="0.9" 
            max="1.1" 
            step="0.001"
            [(ngModel)]="powerSupplyVoltageFactor" 
            (input)="onPowerSupplyVoltageFactorChange()"
            [disabled]="isReading">
        </div>

        @if (plateVoltage !== null) {
          <h6 class="mt-4 mb-3">Read Values</h6>
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead>
                <tr>
                  <th class="text-center w-12p">Ia (mA)</th>
                  <th class="text-center w-12p">Ia comp (mA)</th>
                  <th class="text-center w-12p">Is (mA)</th>
                  <th class="text-center w-12p">Is comp (mA)</th>
                  <th class="text-center w-12p">Va (V)</th>
                  <th class="text-center w-12p">Vs (V)</th>
                  <th class="text-center w-12p">Vpower (V)</th>
                  <th class="text-center w-12p">Vneg (V)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="text-center w-12p">{{plateCurrentAfterPGA?.toFixed(3)}}</td>
                  <td class="text-center w-12p">{{(plateCurrentAfterPGA! * plateCurrentGain).toFixed(3)}}</td>
                  <td class="text-center w-12p">{{screenCurrentAfterPGA?.toFixed(3)}}</td>
                  <td class="text-center w-12p">{{(screenCurrentAfterPGA! * screenCurrentGain).toFixed(3)}}</td>
                  <td class="text-center w-12p">{{plateVoltage?.toFixed(3)}}</td>
                  <td class="text-center w-12p">{{screenVoltage?.toFixed(3)}}</td>
                  <td class="text-center w-12p">{{powerSupplyVoltage?.toFixed(3)}}</td>
                  <td class="text-center w-12p">{{negativeVoltage?.toFixed(3)}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        }
      </div>
      <style>
        .w-12p { width: 12.5%; }
      </style>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary me-auto" (click)="read()" [disabled]="isReading">Read</button>
        <button type="button" class="btn btn-secondary" (click)="close()" [disabled]="isReading">Close</button>
      </div>
    </div>
  </div>
</div>
