<div class="tubes-page">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-0">Tube Models</h2>
      <p class="text-muted mb-0">
        @if (authService.isAuthenticated()) {
          Manage your vacuum tube database
        } @else {
          Browse and experiment with tube models (Sign in to save changes)
        }
      </p>
    </div>
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-outline-secondary" (click)="refreshTubes()">
        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
      </button>
      <a class="btn btn-primary" routerLink="/tube/new">
        <i class="bi bi-plus-lg me-1"></i>
        @if (authService.isAuthenticated()) {
          New Tube
        } @else {
          Try New Tube
        }
      </a>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Total Tubes</h6>
              <h4 class="mb-0">{{ tubes.length }}</h4>
            </div>
            <div class="align-self-center">
              <i class="bi bi-collection fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    @if (authService.isAuthenticated()) {
      <div class="col-md-3">
        <div class="card bg-secondary text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title">My Tubes</h6>
                <h4 class="mb-0">{{ getMyTubesCount() }}</h4>
              </div>
              <div class="align-self-center">
                <i class="bi bi-person-check fs-1"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title">Triodes</h6>
                <h4 class="mb-0">{{ getCountByType('Triode') }}</h4>
              </div>
              <div class="align-self-center">
                <i class="bi bi-cpu fs-1"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-info text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title">Pentodes</h6>
                <h4 class="mb-0">{{ getCountByType('Pentode') }}</h4>
              </div>
              <div class="align-self-center">
                <i class="bi bi-cpu-fill fs-1"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    } @else {
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title">Triodes</h6>
                <h4 class="mb-0">{{ getCountByType('Triode') }}</h4>
              </div>
              <div class="align-self-center">
                <i class="bi bi-cpu fs-1"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-info text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title">Pentodes</h6>
                <h4 class="mb-0">{{ getCountByType('Pentode') }}</h4>
              </div>
              <div class="align-self-center">
                <i class="bi bi-cpu-fill fs-1"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title">Tetrodes</h6>
                <h4 class="mb-0">{{ getCountByType('Tetrode') }}</h4>
              </div>
              <div class="align-self-center">
                <i class="bi bi-motherboard fs-1"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Search and Filter Section -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label for="searchInput" class="form-label">Search Tubes</label>
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input 
              type="text" 
              class="form-control" 
              id="searchInput"
              placeholder="Search by name, manufacturer..."
              [(ngModel)]="searchTerm"
              (input)="filterTubes()">
          </div>
        </div>
        <div class="col-md-2">
          <label for="typeFilter" class="form-label">Filter by Type</label>
          <select 
            class="form-select" 
            id="typeFilter"
            [(ngModel)]="selectedType"
            (change)="filterTubes()">
            <option value="">All Types</option>
            <option value="Triode">Triode</option>
            <option value="Pentode">Pentode</option>
            <option value="Tetrode">Tetrode</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="manufacturerFilter" class="form-label">Filter by Manufacturer</label>
          <select 
            class="form-select" 
            id="manufacturerFilter"
            [(ngModel)]="selectedManufacturer"
            (change)="filterTubes()">
            <option value="">All Manufacturers</option>
            @for (manufacturer of getUniqueManufacturers(); track manufacturer) {
              <option value="{{ manufacturer }}">{{ manufacturer }}</option>
            }
          </select>
        </div>
        <div class="col-md-2">
          @if (authService.isAuthenticated()) {
            <label class="form-label">Ownership</label>
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="myRecordsFilter"
                [(ngModel)]="showMyRecordsOnly"
                (change)="filterTubes()">
              <label class="form-check-label" for="myRecordsFilter">
                <i class="bi bi-person-check me-1"></i>My Records Only
              </label>
            </div>
          }
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="button" class="btn btn-outline-secondary w-100" (click)="clearFilters()">
            <i class="bi bi-x-circle me-1"></i>Clear
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tubes Table -->
  <div class="card">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Tubes List</h5>
        <small class="text-muted">{{ filteredTubes.length }} of {{ tubes.length }} tubes</small>
      </div>
    </div>
    <div class="card-body p-0">
      @if (filteredTubes.length > 0) {
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-dark">
              <tr>
                <th scope="col" style="width: 60px;">#</th>
                <th scope="col">Tube Name</th>
                <th scope="col">Type</th>
                <th scope="col">Manufacturer</th>
                <th scope="col">Comments</th>
                <th scope="col">Last Updated</th>
                <th scope="col" style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (tube of filteredTubes; track tube.id; let i = $index) {
                <tr>
                  <th scope="row" class="text-muted">{{ i + 1 }}</th>
                  <td>
                    <div class="d-flex align-items-center">
                      <a routerLink="/tube/{{ tube.id }}" class="text-decoration-none fw-bold me-2">
                        {{ tube.name }}
                      </a>
                      @if (authService.isAuthenticated() && isMyTube(tube)) {
                        <span class="badge bg-success bg-opacity-25 text-success" title="You own this tube">
                          <i class="bi bi-person-check"></i>
                        </span>
                      }
                    </div>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="getTypeBadgeClass(tube.type)">
                      {{ tube.type }}
                    </span>
                  </td>
                  <td>{{ tube.manufacturer }}</td>
                  <td>
                    <span class="text-truncate d-inline-block" style="max-width: 200px;" 
                          [title]="tube.comments">
                      {{ tube.comments }}
                    </span>
                  </td>
                  <td>
                    <small class="text-muted">{{ formatDate(tube.lastUpdatedOn) }}</small>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <a class="btn btn-outline-primary btn-sm" routerLink="/tube/{{ tube.id }}" 
                         [title]="authService.isAuthenticated() ? 'Edit Tube' : 'View and Experiment with Tube'">
                        @if (authService.isAuthenticated()) {
                          <i class="bi bi-pencil"></i>
                        } @else {
                          <i class="bi bi-eye"></i>
                        }
                      </a>
                      @if (authService.isAuthenticated() && isMyTube(tube)) {
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                (click)="confirmDelete(tube)" title="Delete Tube">
                          <i class="bi bi-trash"></i>
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      } @else {
        <div class="text-center py-5">
          <i class="bi bi-inbox display-1 text-muted"></i>
          <h5 class="mt-3">No tubes found</h5>
          <p class="text-muted">
            @if (searchTerm || selectedType || selectedManufacturer) {
              Try adjusting your search criteria or <button type="button" class="btn btn-link p-0" (click)="clearFilters()">clear filters</button>
            } @else {
              @if (authService.isAuthenticated()) {
                Get started by adding your first tube to the database
              } @else {
                Get started by experimenting with tube models
              }
            }
          </p>
          @if (!searchTerm && !selectedType && !selectedManufacturer) {
            <a class="btn btn-primary" routerLink="/tube/new">
              <i class="bi bi-plus-lg me-1"></i>
              @if (authService.isAuthenticated()) {
                Add First Tube
              } @else {
                Try Creating a Tube
              }
            </a>
          }
        </div>
      }
    </div>
  </div>
</div>
