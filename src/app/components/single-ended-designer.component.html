<div class="single-ended-designer" *ngIf="tube">
  <!-- Header -->
  <div class="mb-3">
    <h6 class="fw-bold mb-2">
      <i class="bi bi-diagram-3 me-2"></i>Single Ended Class A Output Stage Designer
    </h6>
    <p class="text-muted small mb-0">
      Design and analyze single-ended Class A output stages using calculated tube models.
    </p>
  </div>

  <!-- No Models Available Warning -->
  <div *ngIf="availableModels.length === 0" class="alert alert-warning">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <strong>No Models Available</strong><br>
    <small>Please calculate tube model parameters first using the SPICE Parameters section.</small>
  </div>

  <!-- Designer Interface -->
  <div *ngIf="availableModels.length > 0">
    <!-- Model Selection -->
    <div class="mb-4">
      <label for="modelSelect" class="form-label fw-bold">
        <i class="bi bi-cpu me-1"></i>Select Tube Model
      </label>
      <select 
        class="form-select" 
        id="modelSelect" 
        [(ngModel)]="selectedModel" 
        (ngModelChange)="onModelChange()"
        name="modelSelect">
        <option *ngFor="let model of availableModels" [value]="model">
          {{ model }}
        </option>
      </select>
      <div class="form-text">Choose a calculated model to use for the output stage design</div>
    </div>

    <!-- Design Parameters -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-sliders me-2"></i>Design Parameters</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- B+ (HT) Supply Voltage -->
          <div class="col-md-4">
            <div class="mb-3">
              <label for="bPlusInput" class="form-label">
                B+ (HT) Supply Voltage
              </label>
              <div class="input-group">
                <input 
                  type="number" 
                  class="form-control" 
                  id="bPlusInput" 
                  [(ngModel)]="bPlus" 
                  (ngModelChange)="onParameterChange()"
                  name="bPlus"
                  min="0"
                  step="10"
                  placeholder="250">
                <span class="input-group-text">V</span>
              </div>
              <div class="form-text">High tension DC supply voltage</div>
            </div>
          </div>

          <!-- Load Type -->
          <div class="col-md-4">
            <div class="mb-3">
              <label for="loadTypeSelect" class="form-label">
                Load Type
              </label>
              <select 
                class="form-select" 
                id="loadTypeSelect" 
                [(ngModel)]="loadType" 
                (ngModelChange)="onParameterChange()"
                name="loadType">
                <option value="transformer">Output Transformer</option>
                <option value="resistor">Plate Resistor</option>
              </select>
              <div class="form-text">Type of plate load circuit</div>
            </div>
          </div>

          <!-- Load Resistance -->
          <div class="col-md-4">
            <div class="mb-3">
              <label for="rlInput" class="form-label">
                <span *ngIf="loadType === 'transformer'">Primary Impedance (R<sub>Lp</sub>)</span>
                <span *ngIf="loadType === 'resistor'">Plate Resistor (R<sub>p</sub>)</span>
              </label>
              <div class="input-group">
                <input 
                  type="number" 
                  class="form-control" 
                  id="rlInput" 
                  [(ngModel)]="rl" 
                  (ngModelChange)="onParameterChange()"
                  name="rl"
                  min="0"
                  step="100"
                  placeholder="5000">
                <span class="input-group-text">Ω</span>
              </div>
              <div class="form-text" *ngIf="loadType === 'transformer'">Reflected primary impedance to plate</div>
              <div class="form-text" *ngIf="loadType === 'resistor'">DC and AC load resistance</div>
            </div>
          </div>
        </div>

        <div class="row" *ngIf="loadType === 'transformer'">
          <!-- Transformer DCR (only for transformer load) -->
          <div class="col-md-4">
            <div class="mb-3">
              <label for="dcrInput" class="form-label">
                Primary DC Resistance (DCR)
              </label>
              <div class="input-group">
                <input 
                  type="number" 
                  class="form-control" 
                  id="dcrInput" 
                  [(ngModel)]="transformerDCR" 
                  (ngModelChange)="onParameterChange()"
                  name="transformerDCR"
                  min="0"
                  step="10"
                  placeholder="50">
                <span class="input-group-text">Ω</span>
              </div>
              <div class="form-text">DC winding resistance (typically 20-100Ω)</div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Bias Scheme -->
          <div class="col-md-6">
            <div class="mb-3">
              <label for="biasSchemeSelect" class="form-label">
                Bias Scheme
              </label>
              <select 
                class="form-select" 
                id="biasSchemeSelect" 
                [(ngModel)]="biasScheme" 
                (ngModelChange)="onParameterChange()"
                name="biasScheme">
                <option value="cathode">Cathode Self-Bias</option>
                <option value="fixed">Fixed Negative Bias</option>
              </select>
              <div class="form-text">Method for establishing grid bias</div>
            </div>
          </div>

          <!-- Quiescent Current Iq -->
          <div class="col-md-6">
            <div class="mb-3">
              <label for="iqInput" class="form-label">
                Quiescent Plate Current (I<sub>q</sub>)
                <span *ngIf="recommendedIqMin > 0" class="badge bg-info ms-2">
                  Recommended: {{ recommendedIqMin.toFixed(1) }} - {{ recommendedIqMax.toFixed(1) }} mA
                </span>
              </label>
              <div class="input-group">
                <input 
                  type="number" 
                  class="form-control" 
                  id="iqInput" 
                  [(ngModel)]="quiescentCurrent" 
                  (ngModelChange)="onParameterChange()"
                  name="quiescentCurrent"
                  min="0"
                  step="5"
                  placeholder="50">
                <span class="input-group-text">mA</span>
              </div>
              <div class="form-text">Choose I<sub>q</sub> for P<sub>q</sub> = 30-50% of P<sub>D,max</sub></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Operating Point Results -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>Operating Point (Q-Point)</h6>
          <button 
            type="button" 
            class="btn btn-sm btn-outline-secondary"
            (click)="toggleCalculations()">
            <i class="bi" [ngClass]="showCalculations ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
            {{ showCalculations ? 'Hide' : 'Show' }} Details
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Quiescent Plate Voltage -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label text-muted">Quiescent Plate Voltage (V<sub>p</sub>)</label>
              <div class="h5 mb-0">
                {{ quiescentPlateVoltage.toFixed(2) }} V
                <small class="text-muted">(≈ B+ for SE)</small>
              </div>
            </div>
          </div>

          <!-- Quiescent Plate Current -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label text-muted">Quiescent Plate Current (I<sub>q</sub>)</label>
              <div class="h5 mb-0">
                {{ quiescentCurrent.toFixed(2) }} mA
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Required Grid Bias -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label text-muted">Required Grid Bias (V<sub>g</sub>)</label>
              <div class="h5 mb-0">
                {{ requiredGridBias.toFixed(3) }} V
              </div>
            </div>
          </div>

          <!-- Quiescent Plate Dissipation -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label text-muted">Quiescent Plate Dissipation (P<sub>q</sub>)</label>
              <div class="h5 mb-0" [ngClass]="getPlateDissipationClass()">
                {{ quiescentPlateDissipation.toFixed(3) }} W
                <span *ngIf="tube?.maximumPlateDissipation" class="small">
                  ({{ plateDissipationPercentage.toFixed(1) }}% of {{ tube.maximumPlateDissipation }}W max)
                </span>
              </div>
              <small *ngIf="isPlateDissipationExceeded()" class="text-danger">
                <i class="bi bi-exclamation-triangle me-1"></i>Exceeds maximum plate dissipation!
              </small>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Maximum Output Power -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label text-muted">Maximum Output Power (RMS)</label>
              <div class="h5 mb-0">
                {{ maxOutputPower.toFixed(3) }} W
              </div>
              <small class="text-muted">P<sub>o,max</sub> ≈ I<sub>q</sub><sup>2</sup> × R<sub>L</sub> / 2</small>
            </div>
          </div>

          <!-- Cathode Bias Components (if applicable) -->
          <div class="col-md-6" *ngIf="biasScheme === 'cathode'">
            <div class="mb-3">
              <label class="form-label text-muted">Cathode Bias Components</label>
              <div class="small">
                <div><strong>R<sub>k</sub>:</strong> {{ cathodeResistor.toFixed(1) }} Ω</div>
                <div><strong>C<sub>k</sub>:</strong> {{ cathodeBypassCapacitor.toFixed(1) }} µF (minimum)</div>
              </div>
              <small class="text-muted">For f<sub>low</sub> = 20 Hz</small>
            </div>
          </div>
        </div>

        <!-- Load Line Details (collapsible) -->
        <div *ngIf="showCalculations && dcLoadLine.length > 0" class="mt-3">
          <div *ngIf="loadType === 'transformer'">
            <h6 class="text-muted small mb-2">DC Load Line:</h6>
            <div class="small">
              Nearly vertical, slope = -1/DCR = -1/{{ transformerDCR }}Ω
              <br>V<sub>q</sub> = B+ - I<sub>q</sub> × DCR = {{ quiescentPlateVoltage.toFixed(1) }}V
            </div>
            <h6 class="text-muted small mb-2 mt-3">AC Load Line:</h6>
            <div class="small">
              Slope = -1/R<sub>Lp</sub> = -1/{{ rl }}Ω through Q-point
            </div>
            <div class="row mt-2">
              <div class="col-md-6">
                <div class="small">
                  <strong>Max Voltage Swing:</strong><br>
                  V<sub>a</sub> = {{ acLoadLine[0].va.toFixed(1) }} V, I<sub>a</sub> = {{ acLoadLine[0].ia.toFixed(1) }} mA
                </div>
              </div>
              <div class="col-md-6">
                <div class="small">
                  <strong>Max Current Swing:</strong><br>
                  V<sub>a</sub> = {{ acLoadLine[1].va.toFixed(1) }} V, I<sub>a</sub> = {{ acLoadLine[1].ia.toFixed(1) }} mA
                </div>
              </div>
            </div>
          </div>
          
          <div *ngIf="loadType === 'resistor'">
            <h6 class="text-muted small mb-2">DC/AC Load Line (same for resistor):</h6>
            <div class="small">
              I<sub>a</sub> = (B+ - V<sub>a</sub>) / R<sub>p</sub> = ({{ bPlus }}V - V<sub>a</sub>) / {{ rl }}Ω
              <br>Slope = -1/R<sub>p</sub> = -1/{{ rl }}Ω
            </div>
            <div class="row mt-2">
              <div class="col-md-6">
                <div class="small">
                  <strong>Cutoff Point:</strong><br>
                  V<sub>a</sub> = {{ dcLoadLine[0].va }} V, I<sub>a</sub> = {{ dcLoadLine[0].ia }} mA
                </div>
              </div>
              <div class="col-md-6">
                <div class="small">
                  <strong>Saturation Point:</strong><br>
                  V<sub>a</sub> = {{ dcLoadLine[1].va }} V, I<sub>a</sub> = {{ dcLoadLine[1].ia.toFixed(1) }} mA
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Load Line Plot -->
    <div class="card mb-3">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Plate Characteristics & Load Line</h6>
      </div>
      <div class="card-body">
        <div class="chart-container" style="position: relative; height: 500px;">
          <canvas #chartCanvas></canvas>
        </div>
      </div>
    </div>

    <!-- Design Notes -->
    <div class="alert alert-info">
      <h6 class="alert-heading">
        <i class="bi bi-info-circle me-2"></i>Single Ended Class A Design Notes
      </h6>
      
      <div *ngIf="loadType === 'transformer'">
        <strong>Output Transformer Load:</strong>
        <ul class="mb-0 small mt-2">
          <li><strong>DC Load Line:</strong> Nearly vertical at V<sub>a</sub> ≈ B+ - I<sub>q</sub>×DCR (transformer DCR typically 20-100Ω)</li>
          <li><strong>AC Load Line:</strong> Slope = -1/R<sub>Lp</sub> through Q-point, represents dynamic signal swing</li>
          <li><strong>Reflected Impedance:</strong> R<sub>Lp</sub> is the speaker impedance reflected to the primary (Z<sub>speaker</sub> × n²)</li>
          <li><strong>Q-point Selection:</strong> Choose I<sub>q</sub> so P<sub>q</sub> = 30-50% of P<sub>D,max</sub></li>
          <li><strong>Maximum Power:</strong> P<sub>o,max</sub> limited by voltage swing or current swing, whichever is smaller</li>
          <li><strong>Efficiency:</strong> Theoretical maximum ~50% for Class A, practical 25-35%</li>
        </ul>
      </div>
      
      <div *ngIf="loadType === 'resistor'">
        <strong>Plate Resistor Load:</strong>
        <ul class="mb-0 small mt-2">
          <li><strong>DC = AC Load Line:</strong> Same line for all frequencies: I<sub>a</sub> = (B+ - V<sub>a</sub>) / R<sub>p</sub></li>
          <li><strong>Q-point:</strong> Typically at V<sub>q</sub> = B+ - I<sub>q</sub> × R<sub>p</sub> on the load line</li>
          <li><strong>Center Bias:</strong> For maximum symmetrical swing, choose I<sub>q</sub> = B+ / (2 × R<sub>p</sub>), giving V<sub>q</sub> = B+/2</li>
          <li><strong>Power Dissipation:</strong> Resistor dissipates P<sub>R</sub> = I<sub>q</sub>² × R<sub>p</sub> continuously</li>
          <li><strong>Maximum Power:</strong> P<sub>o,max</sub> ≈ (V<sub>q</sub> × I<sub>q</sub>) / 2, much lower efficiency than transformer</li>
          <li><strong>Use Cases:</strong> Typically for voltage amplification stages, not power output (inefficient)</li>
        </ul>
      </div>
      
      <p class="mb-0 small mt-2">
        <strong>General:</strong> Ensure operating point and signal swings stay within maximum ratings (dissipation, voltage, current).
        Grid bias calculated to achieve desired I<sub>q</sub> at the Q-point using the tube model.
      </p>
    </div>
  </div>
</div>
